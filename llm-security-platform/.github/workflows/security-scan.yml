name: LLM Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Tous les jours Ã  minuit
  workflow_dispatch:  # Permet le dÃ©clenchement manuel

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install global dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Install orchestrator dependencies
      run: |
        if [ -f orchestrator/requirements.txt ]; then 
          pip install -r orchestrator/requirements.txt
        fi
    
    - name: Install analyzer dependencies
      run: |
        if [ -f analyzer/requirements.txt ]; then 
          pip install -r analyzer/requirements.txt
        fi
    
    - name: Install runner dependencies
      run: |
        if [ -f runners/requirements.txt ]; then 
          pip install -r runners/requirements.txt
        fi
    
    - name: Run quick test
      run: |
        python quick_test.py
      continue-on-error: true
    
    - name: Run platform validation
      run: |
        python test_platform.py
      continue-on-error: true
    
    - name: Run security scan (demo mode)
      run: |
        cd orchestrator
        python orchestrator.py "You are a helpful AI assistant" --demo
      env:
        LLM_SECURITY_LLM_ENDPOINT: ${{ secrets.LLM_ENDPOINT || 'http://localhost:11434' }}
        LLM_SECURITY_LLM_MODEL: ${{ secrets.LLM_MODEL || 'llama2' }}
    
    - name: Analyze results
      run: |
        cd analyzer
        python analyzer.py ../orchestrator/results/*.json || echo "No results to analyze"
      continue-on-error: true
    
    - name: Run security checks
      run: |
        # Safety check
        safety check -r orchestrator/requirements.txt --continue-on-error || echo "Safety check completed with warnings"
        
        # Bandit security scan
        bandit -r orchestrator/ analyzer/ security/ logger/ alerting/ -f json -o bandit-report.json || echo "Bandit scan completed"
      continue-on-error: true
    
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          orchestrator/results/
          analyzer/reports/
          test_results/
          bandit-report.json
        retention-days: 30
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: logs
        path: |
          logs/
        retention-days: 7
    
    - name: Create GitHub Issue on failure
      if: failure() && github.event_name != 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `[Security] Build failed - ${context.workflow}`;
          const body = `
          ## ðŸ”’ Security Scan Failed
          
          **Workflow:** ${context.workflow}
          **Run:** ${context.runNumber}
          **Commit:** ${context.sha}
          **Branch:** ${context.ref}
          
          [View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'ci-failure', 'automated']
          });
