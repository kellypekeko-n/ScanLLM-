version: '3.8'

services:
  # Runner principal
  runner-1:
    build:
      context: ..
      dockerfile: runners/Dockerfile
    container_name: llm-security-runner-1
    environment:
      - LOG_LEVEL=INFO
      - RUNNER_OUTPUT_DIR=/app/results
      - LLM_SECURITY_LLM_ENDPOINT=http://host.docker.internal:11434
      - LLM_SECURITY_LLM_MODEL=llama2
    volumes:
      - ./config:/app/config:ro
      - ./results:/app/results
      - ./logs:/app/logs
    networks:
      - llm-security-network
    restart: unless-stopped
    command: ["--config", "/app/config/config.yaml", "--continuous", "--interval", "3600"]
    # Isolation réseau - accès restreint
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  # Runner worker 2 (optionnel)
  runner-2:
    build:
      context: ..
      dockerfile: runners/Dockerfile
    container_name: llm-security-runner-2
    environment:
      - LOG_LEVEL=INFO
      - RUNNER_OUTPUT_DIR=/app/results
      - LLM_SECURITY_LLM_ENDPOINT=http://host.docker.internal:11434
      - LLM_SECURITY_LLM_MODEL=llama2
    volumes:
      - ./config:/app/config:ro
      - ./results:/app/results
      - ./logs:/app/logs
    networks:
      - llm-security-network
    restart: unless-stopped
    command: ["--config", "/app/config/config.yaml", "--output", "/app/results"]
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    profiles:
      - multi-worker

  # Runner worker 3 (optionnel)
  runner-3:
    build:
      context: ..
      dockerfile: runners/Dockerfile
    container_name: llm-security-runner-3
    environment:
      - LOG_LEVEL=INFO
      - RUNNER_OUTPUT_DIR=/app/results
      - LLM_SECURITY_LLM_ENDPOINT=http://host.docker.internal:11434
      - LLM_SECURITY_LLM_MODEL=llama2
    volumes:
      - ./config:/app/config:ro
      - ./results:/app/results
      - ./logs:/app/logs
    networks:
      - llm-security-network
    restart: unless-stopped
    command: ["--config", "/app/config/config.yaml", "--output", "/app/results"]
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    profiles:
      - multi-worker

networks:
  llm-security-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  results:
  logs:
